# 비나(VINA) 메모리 관리 시스템

이 디렉토리는 비나 챗봇의 메모리 저장 및 관리 시스템입니다. 비나는 대화 내용에서 중요한 정보를 추출하여 자동으로 메모리 파일에 저장할 수 있습니다.

## 메모리 파일 구조

* **facts.md**: 사용자에 대한 사실 정보, 취향, 선호도, 일상 루틴 등을 저장합니다.
* **contextual_rules.md**: 비나의 행동 규칙, 대화 스타일, 특정 상황에서의 대응 등을 저장합니다.
* **explicit_rules.json**: 시간/조건 기반 자동 응답 규칙을 저장합니다.
* **logs/**: 대화 내역을 JSONL 형식으로 저장합니다.

## 메모리 관리 명령어

사용자는 다음 명령어를 통해 메모리 시스템을 관리할 수 있습니다:

### 기본 명령어

* **!메모리**: 도움말 표시
* **!메모리 상태**: 현재 저장된 메모리 파일 상태 확인
* **!메모리 보기**: 현재 저장된 메모리 파일들의 내용 보기
* **!메모리 설정**: 메모리 관리 설정 보기 및 변경

### 메모리 분석 명령어

* **!메모리 추출 [메시지]**: 입력한 메시지에서 중요 정보 추출
* **!메모리 분석 [메시지ID]**: 이전 메시지 ID에서 중요 정보 추출

### 직접 추가 명령어

* **!메모리 추가 사실 [내용]**: facts.md에 새 정보 추가
* **!메모리 추가 규칙 [내용]**: contextual_rules.md에 새 규칙 추가
* **!메모리 추가 명시적**: explicit_rules.json에 새 규칙 추가 가이드 및 추가 기능

### 명시적 규칙 관리 명령어

* **!메모리 삭제 명시적 [ID]**: 명시적 규칙 삭제
* **!메모리 수정 명시적 [JSON]**: 명시적 규칙 수정
* **!메모리 검증**: 메모리 파일 형식 검증 및 문제 보고
* **!메모리 검증 수정**: 문제가 있는 규칙 자동 수정
* **!메모리 규칙 목록**: 현재 등록된 모든 명시적 규칙 목록 보기

### 자연어 규칙 관리

비나는 명령어 외에도 자연어 요청을 통해 규칙을 관리할 수 있습니다:

* **규칙 삭제 요청**: "아침 인사 규칙 삭제해줘", "morning_greeting 규칙은 필요 없어"
* **규칙 변경 요청**: "아침 인사 시간을 9시로 변경해줘", "취침 알림을 10시 30분으로 바꿔줘"
* **규칙 추가 요청**: "저녁 6시에 운동 알림 규칙 추가해줘", "주말 아침 9시에 일정 확인 알림 설정해줘"

비나는 이러한 자연어 요청을 분석하여 적절한 규칙을 추가, 변경, 또는 삭제합니다.

## 메모리 업데이트 메커니즘

### 자동 메모리 업데이트

비나는 모든 사용자 메시지를 분석하여 중요한 정보를 자동으로 저장할 수 있습니다:

1. 각 메시지는 Claude API를 사용하여 분석됩니다.
2. 분석된 정보는 신뢰도(confidence) 점수와 함께 반환됩니다.
3. 신뢰도 점수가 임계값(기본 70%) 이상인 정보만 저장됩니다.
4. 기존 정보와 유사/중복된 내용은 업데이트됩니다.

### 메모리 저장 규칙

* **사용자 정보(facts.md)**: 사용자의 취향, 개인 정보, 일상 등은 적절한 섹션에 분류되어 저장됩니다.
* **맥락적 규칙(contextual_rules.md)**: 비나의 행동에 영향을 주는 규칙들이 상황별/유형별로 분류됩니다.
* **명시적 규칙(explicit_rules.json)**: 시간/조건 기반 규칙은 JSON 형식으로 저장됩니다.

### 명시적 규칙 형식

명시적 규칙은 다음과 같은 형식으로 저장됩니다:

```json
{
  "id": "규칙_아이디",
  "name": "규칙 이름",
  "condition_tags": ["time==08:00", "weekday==1-5"],
  "condition_description": "조건에 대한 설명",
  "action_description": "수행할 행동 설명",
  "active": true
}
```

**조건 태그 규칙:**
* `time==HH:MM` - 특정 시간에 실행 (예: `time==08:00`)
* `last_message_elapsed>N` - 마지막 메시지 후 N초 경과 (예: `last_message_elapsed>1200`)
* `weekday==N-M` - 특정 요일 범위에 실행 (예: `weekday==1-5`, 1=월요일, 7=일요일)

## 예시 사용법

### 메모리 분석 예시

```
사용자: !메모리 추출 나는 딸기 알레르기가 있어. 그리고 취침 시간이 보통 11시야.
비나: 🔍 메시지 분석 중...
✅ 메시지 분석 결과
사용자 정보(2개):
- 딸기 알레르기가 있음 (92%)
- 취침 시간: 보통 11시 (85%)
```

### 직접 추가 예시

```
사용자: !메모리 추가 사실 좋아하는 게임: 스타크래프트2
비나: ✅ 사용자 정보에 추가되었습니다: `좋아하는 게임: 스타크래프트2`
```

### 명시적 규칙 관리 예시

```
사용자: !메모리 추가 명시적
비나: 📝 명시적 규칙 추가 방법...

사용자: !메모리 추가 명시적 {"id": "lunch_reminder", "name": "점심 알림", "condition_tags": ["time==12:00", "weekday==1-5"], "condition_description": "평일 점심시간에 실행", "action_description": "점심 식사 시간 알림", "active": true}
비나: ✅ 명시적 규칙 'lunch_reminder'이(가) 추가되었습니다.

사용자: !메모리 검증
비나: ⚠️ 1개의 문제 있는 규칙이 발견되었습니다...

사용자: !메모리 검증 수정
비나: ✅ 1개의 규칙이 수정되었습니다.
```

### 자연어 규칙 관리 예시

```
사용자: 아침 인사 규칙 삭제해줘
비나: 🗑️ 규칙 'morning_greeting'이(가) 삭제되었습니다.

사용자: 점심 알림 시간을 1시로 변경해줘
비나: ✅ 규칙 'lunch_reminder'이(가) 업데이트되었습니다. 알림 시간이 13:00으로 변경되었습니다.

사용자: 매일 저녁 7시에 운동 알림 추가해줘
비나: ✅ 새 규칙 'exercise_reminder'이(가) 추가되었습니다. 매일 저녁 7시에 운동 알림을 보내드릴게요.
```

## 기술적 구현

메모리 업데이트 시스템은 다음과 같은 과정으로 작동합니다:

1. 사용자 메시지를 Claude API에 전송하여 중요 정보 추출
2. 반환된 JSON 데이터에서 신뢰도 높은 정보만 필터링
3. 각 항목을 적절한 파일과 섹션에 저장
4. 중복/충돌 정보가 있는 경우 새 정보로 업데이트

현재 구현에서는 다음 요소들을 사용합니다:

* Claude API로 메시지 분석
* 신뢰도 기준값: 70%
* 자동 분석 대상: 모든 메시지
* 섹션 기반 저장 구조 