# 🦜 비나 | VINA

VINA는 디스코드에서 동작하는 개인화된 AI 어시스턴트 봇입니다. 사용자와 친근하게 대화하며 특정 규칙에 따라 자동으로 응답할 수 있는 기능을 제공합니다.

## 1. 시스템 구조

### 1.1 주요 파일 구성

```
/
├── bot.py                    # 메인 봇 코드
├── vina_config/              # 구성 파일 디렉토리
│   ├── system_prompt_response.txt  # 응답 생성용 시스템 프롬프트
│   └── system_prompt_context.txt   # 문맥 분석용 시스템 프롬프트
├── vina_memory/              # 메모리 및 로그 디렉토리
│   ├── facts.md              # 사용자 정보
│   ├── contextual_rules.md   # 맥락적 규칙
│   ├── explicit_rules.json   # 명시적 규칙 정의
│   └── logs/                 # 로그 저장 디렉토리
│       └── vina_history.jsonl # 대화 기록
└── .env                      # 환경 변수 파일 (API 키 등)
```

### 1.2 핵심 모듈

- **메인 봇 로직 (bot.py)**: 디스코드 이벤트 처리, 메시지 응답, 규칙 처리
- **메모리 관리**: 대화 기록 저장 및 로드
- **규칙 시스템**: 명시적 규칙에 따른 자동 응답 생성
- **LLM 통합**: Claude API를 통한 응답 생성

## 2. 주요 기능 및 구현 사항

### 2.1 대화 기능

- **일반 대화**: 사용자 메시지에 맥락을 고려한 응답 생성
- **대화 기록**: JSONL 형식으로 모든 대화를 저장하고 활용
- **반말 기반 친근한 대화**: 일관된 반말 어투로 친근한 대화 유지

### 2.2 규칙 기반 자동 응답

- **명시적 규칙 시스템**: JSON 파일에 정의된 규칙에 따라 자동 응답
- **조건 기반 트리거**: 시간, 요일, 마지막 메시지 경과 시간 등 다양한 조건
- **자연스러운 자동 응답**: 자동으로 트리거되었음을 사용자가 알아차리지 못하도록 설계

### 2.3 메시지 추적 및 상태 관리

- **마지막 메시지 시간 추적**: 전역 변수로 마지막 메시지 시간 관리
- **상태 진단 명령어**: `!진단` 명령어를 통한 봇 상태 확인 및 디버깅
- **시간 기반 조건 평가**: 마지막 메시지 경과 시간 등을 기반으로 규칙 조건 평가

### 2.4 특수 기능

- **`/None` 응답 처리**: 특정 상황에서 메시지를 보내지 않아야 할 때 사용
- **사용자 정보 자연스러운 활용**: 필요할 때만 사용자 정보를 참고하는 개선된 방식

## 3. 주요 구현 상세

### 3.1 프롬프트 구조

모든 대화와 규칙 트리거는 다음과 같은 일관된 프롬프트 구조를 사용합니다:

```
1. 사용자 기억 정보
2. VINA의 행동 규칙
3. 상황 맥락
4. 이전 대화
5. 현재 요청/규칙
```

이 구조는 모델이 맥락을 이해하고 일관된 응답을 생성하는데 도움을 줍니다.

### 3.2 메시지 처리 흐름

1. 사용자 메시지 수신
2. 최근 대화 기록 로드
3. 프롬프트 생성
4. Claude API로 응답 생성
5. `/None` 응답 확인 (있으면 메시지 전송 스킵)
6. 응답 저장 및 전송

### 3.3 규칙 처리 흐름

1. 주기적 규칙 체크 (1분 간격)
2. 모든 활성화된 규칙의 조건 평가
3. 조건 충족된 규칙에 대해 응답 생성
4. `/None` 응답 확인 (있으면 메시지 전송 스킵)
5. 응답 저장 및 전송

## 4. 사용 시나리오

### 4.1 일반 대화

```
사용자: 안녕! 오늘 날씨 어때?
VINA: 안녕! 지금 서울은 맑고 23도래. 완전 봄날씨야! 🌞 오늘 무슨 계획 있어?
```

### 4.2 장기 부재 후 자동 메시지

```
[마지막 메시지로부터 20분 이상 경과]
VINA: 한동안 조용했네~ 지금 뭐 하고 있어? 혹시 그 프로젝트 마감 준비 중이야? 😊
```

### 4.3 진단 명령어 사용

```
사용자: !진단
VINA: 🔍 시스템 진단 보고서
⏰ 현재 시간: 2024-04-16 11:30:45
📌 마지막 메시지:
  - 시간: 2024-04-16T11:25:30
  - 경과: 300.0초 (5.0분)
```

### 4.4 `/None` 응답 처리

```
[마지막 메시지로부터 20분 이상 경과했으나 늦은 밤 시간]
VINA: /None
[메시지가 디스코드에 전송되지 않음]
```

## 5. 주요 개선사항 이력

### 5.1 채널 관리 개선
- 채널별 메시지 관리에서 단일 타임스탬프 관리로 단순화
- 메모리 사용량 감소 및 코드 복잡성 감소

### 5.2 프롬프트 구조 개선
- 기억 정보 - 규칙 - 이전 대화 - 현재 요청 순서로 재구성
- 명확한 지시로 더 일관된 응답 생성

### 5.3 반말 일관성 향상
- 시스템 프롬프트와 응답 가이드에 명확한 반말 지시 추가
- 존댓말 사용 방지를 위한 추가 지침

### 5.4 사용자 정보 자연스러운 활용
- 무리한 사용자 정보 언급 방지
- 필요할 때만 자연스럽게 정보 활용

### 5.5 `/None` 응답 기능
- 특정 상황에서 메시지 전송 생략 기능 구현
- 불필요한 알림 방지

## 6. 명령어 목록

| 명령어 | 설명 |
|--------|------|
| `!진단` | 기본 시스템 상태 정보 표시 |
| `!진단 규칙` | 모든 규칙의 상태와 조건 평가 정보 표시 |
| `!진단 강제실행 [규칙ID]` | 특정 규칙을 강제로 실행 (예: `!진단 강제실행 long_absence`) |
| `!진단 메시지추가` | 마지막 메시지 시간 업데이트 (테스트용) |
| `!진단 시뮬레이션 [조건]` | 특정 조건 시뮬레이션 (예: `!진단 시뮬레이션 last_message_elapsed>60`) |

## 7. 환경 설정

### 7.1 필수 환경 변수
- `ANTHROPIC_API_KEY`: Claude API 키
- `DISCORD_BOT_TOKEN`: 디스코드 봇 토큰

### 7.2 설치 요구사항
- Python 3.8 이상
- discord.py
- anthropic Python SDK
- python-dotenv

## 8. 향후 개선 계획

- **다중 서버 지원**: 여러 디스코드 서버에서 독립적으로 작동
- **대화 분석 기능**: 대화 패턴 분석 및 개인화 개선
- **음성 채널 통합**: 음성 채널에서도 상호작용 지원
- **웹 인터페이스**: 규칙 및 설정 관리를 위한 웹 인터페이스 
